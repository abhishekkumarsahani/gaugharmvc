@model GauGhar.Models.DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
}

<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="bi bi-speedometer2 me-2"></i>Dashboard
        </h1>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary btn-sm" id="todayBtn">
                <i class="bi bi-calendar-day"></i> Today
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm" id="weekBtn">
                <i class="bi bi-calendar-week"></i> This Week
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm" id="monthBtn">
                <i class="bi bi-calendar-month"></i> This Month
            </button>
        </div>
    </div>

    <!-- Stats Cards Row -->
    <div class="row">
        <!-- Total Cows Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Cows
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.TotalCows</div>
                            <div class="mt-2">
                                <span class="badge bg-success">Active: @Model.ActiveCows</span>
                                <span class="badge bg-info ms-1">Pregnant: @Model.PregnantCows</span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-cow fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Today's Milk Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Today's Milk
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.TodayMilk.ToString("0.00") L</div>
                            <div class="mt-2 text-xs">
                                <i class="bi bi-sun me-1 text-warning"></i>Morning: @((Model.TodayMilk / 2).ToString("0.00"))
                                <i class="bi bi-moon ms-3 me-1 text-secondary"></i>Evening: @((Model.TodayMilk / 2).ToString("0.00"))
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-droplet fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Today's Sales Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Today's Sales
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">Rs. @Model.TodaySales.ToString("N2")</div>
                            <div class="mt-2 text-xs">
                                <i class="bi bi-arrow-up-circle text-success me-1"></i>
                                <span class="text-success">Daily Sales</span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-cash-stack fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Today's Expenses Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Today's Expenses
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">Rs. @Model.TodayExpenses.ToString("N2")</div>
                            <div class="mt-2 text-xs">
                                <i class="bi bi-exclamation-triangle text-danger me-1"></i>
                                <span class="text-danger">Manage Expenses</span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-receipt-cutoff fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row">
        <!-- Milk Production Chart -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-graph-up me-2"></i>Milk Production Trend
                    </h6>
                    <div class="dropdown no-arrow">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
                           data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="bi bi-three-dots-vertical text-gray-400"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
                             aria-labelledby="dropdownMenuLink">
                            <div class="dropdown-header">Chart Options:</div>
                            <a class="dropdown-item" href="#" id="weekChart">Last 7 Days</a>
                            <a class="dropdown-item" href="#" id="monthChart">This Month</a>
                            <a class="dropdown-item" href="#" id="yearChart">This Year</a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="milkProductionChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profit/Loss Summary -->
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-pie-chart me-2"></i>Profit & Loss Summary
                    </h6>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <div id="profitLossCircle" class="mb-3"></div>
                        <div class="small text-gray-500">
                            Total Sales: <span id="totalSales" class="font-weight-bold"></span><br>
                            Total Expenses: <span id="totalExpenses" class="font-weight-bold"></span><br>
                            Net Profit: <span id="netProfit" class="font-weight-bold"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-lightning me-2"></i>Quick Stats
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 text-center mb-3">
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="avgMilkPerCow">0.0</div>
                            <div class="text-xs font-weight-bold text-primary text-uppercase">
                                Avg Milk/Cow
                            </div>
                        </div>
                        <div class="col-6 text-center mb-3">
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="milkRate">0.0</div>
                            <div class="text-xs font-weight-bold text-success text-uppercase">
                                Milk Rate (Rs/L)
                            </div>
                        </div>
                        <div class="col-6 text-center">
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="expenseRatio">0%</div>
                            <div class="text-xs font-weight-bold text-danger text-uppercase">
                                Expense Ratio
                            </div>
                        </div>
                        <div class="col-6 text-center">
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="profitMargin">0%</div>
                            <div class="text-xs font-weight-bold text-warning text-uppercase">
                                Profit Margin
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Row -->
    <div class="row">
        <div class="col-lg-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-lightning-charge me-2"></i>Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-2 col-6 mb-3">
                            <a asp-controller="Milk" asp-action="Create" class="btn btn-success btn-circle btn-lg">
                                <i class="bi bi-plus-lg"></i>
                            </a>
                            <p class="mt-2 small">Add Milk Entry</p>
                        </div>
                        <div class="col-md-2 col-6 mb-3">
                            <a asp-controller="Sales" asp-action="Create" class="btn btn-warning btn-circle btn-lg">
                                <i class="bi bi-cart-plus"></i>
                            </a>
                            <p class="mt-2 small">Record Sale</p>
                        </div>
                        <div class="col-md-2 col-6 mb-3">
                            <a asp-controller="Expense" asp-action="Create" class="btn btn-danger btn-circle btn-lg">
                                <i class="bi bi-cash-coin"></i>
                            </a>
                            <p class="mt-2 small">Add Expense</p>
                        </div>
                        <div class="col-md-2 col-6 mb-3">
                            <a asp-controller="Cow" asp-action="Create" class="btn btn-primary btn-circle btn-lg">
                                <i class="bi bi-plus-circle"></i>
                            </a>
                            <p class="mt-2 small">Add New Cow</p>
                        </div>
                        <div class="col-md-2 col-6 mb-3">
                            <a asp-controller="Cow" asp-action="Index" class="btn btn-info btn-circle btn-lg">
                                <i class="bi bi-list-ul"></i>
                            </a>
                            <p class="mt-2 small">View All Cows</p>
                        </div>
                        <div class="col-md-2 col-6 mb-3">
                            <a asp-controller="Milk" asp-action="Index" class="btn btn-secondary btn-circle btn-lg">
                                <i class="bi bi-clipboard-data"></i>
                            </a>
                            <p class="mt-2 small">Milk Records</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row">
        <div class="col-lg-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-clock-history me-2"></i>Recent Activity
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="recentActivity">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Activity</th>
                                    <th>Details</th>
                                    <th>User</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Just now</td>
                                    <td>Logged in</td>
                                    <td>System access</td>
                                    <td>You</td>
                                </tr>
                                <!-- This will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Milk Production Chart
        var milkData = @Html.Raw(Json.Serialize(ViewBag.MilkChartData)) || [];
        var days = milkData.map(x => x.day) || [];
        var quantities = milkData.map(x => x.totalMilk) || [];

        var ctx = document.getElementById('milkProductionChart').getContext('2d');
        var milkChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: days,
                datasets: [{
                    label: 'Milk Production (L)',
                    data: quantities,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    fill: true,
                    pointBackgroundColor: 'rgb(75, 192, 192)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(75, 192, 192)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Daily Milk Production (Liters)'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Liters'
                        },
                        grid: {
                            drawBorder: false
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Day of Month'
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        // Load Profit/Loss data for current month
        $(document).ready(function () {
            var currentDate = new Date();
            loadProfitLossData(currentDate.getFullYear(), currentDate.getMonth() + 1);
            loadQuickStats();

            // Set up button click handlers
            $('#todayBtn').click(function () {
                loadTodayData();
            });

            $('#weekBtn').click(function () {
                loadWeekData();
            });

            $('#monthBtn').click(function () {
                loadMonthData();
            });
        });

        function loadProfitLossData(year, month) {
            $.ajax({
                url: '@Url.Action("GetMonthlyProfitLoss", "Dashboard")',
                data: { year: year, month: month },
                success: function (data) {
                    $('#totalSales').text('Rs. ' + data.totalSales.toFixed(2));
                    $('#totalExpenses').text('Rs. ' + data.totalExpenses.toFixed(2));
                    $('#netProfit').text('Rs. ' + data.profitLoss.toFixed(2));

                    if (data.isProfit) {
                        $('#netProfit').addClass('text-success').removeClass('text-danger');
                    } else {
                        $('#netProfit').addClass('text-danger').removeClass('text-success');
                    }

                    // Create profit/loss circle
                    createProfitLossCircle(data.totalSales, data.totalExpenses, data.profitLoss);
                },
                error: function () {
                    $('#totalSales').text('Rs. 0.00');
                    $('#totalExpenses').text('Rs. 0.00');
                    $('#netProfit').text('Rs. 0.00').addClass('text-secondary');
                }
            });
        }

        function createProfitLossCircle(sales, expenses, profit) {
            var profitPercentage = sales > 0 ? (profit / sales) * 100 : 0;
            var radius = 60;
            var circumference = 2 * Math.PI * radius;
            var offset = circumference - (Math.abs(profitPercentage) / 100) * circumference;

            var circleHtml = `
                    <svg width="150" height="150" viewBox="0 0 150 150">
                        <circle cx="75" cy="75" r="${radius}" stroke="#e0e0e0" stroke-width="10" fill="none"/>
                        <circle cx="75" cy="75" r="${radius}" stroke="${profit >= 0 ? '#28a745' : '#dc3545'}"
                                stroke-width="10" fill="none" stroke-dasharray="${circumference}"
                                stroke-dashoffset="${offset}" transform="rotate(-90 75 75)"/>
                        <text x="75" y="75" text-anchor="middle" dy=".3em" font-size="18"
                              fill="${profit >= 0 ? '#28a745' : '#dc3545'}" font-weight="bold">
                            ${profitPercentage.toFixed(1)}%
                        </text>
                        <text x="75" y="95" text-anchor="middle" font-size="12" fill="#666">
                            ${profit >= 0 ? 'Profit' : 'Loss'}
                        </text>
                    </svg>
                `;
            $('#profitLossCircle').html(circleHtml);
        }

        function loadQuickStats() {
            // These would normally come from API calls
            $('#avgMilkPerCow').text('15.2');
            $('#milkRate').text('75.5');
            $('#expenseRatio').text('42%');
            $('#profitMargin').text('58%');
        }

        function loadTodayData() {
            // Simulate loading today's data
            $('#todayBtn').addClass('active').siblings().removeClass('active');
            updateChartData([1, 2, 3, 4, 5], [15.5, 16.2, 15.8, 16.5, 17.1]);
        }

        function loadWeekData() {
            $('#weekBtn').addClass('active').siblings().removeClass('active');
            updateChartData(['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                [105.5, 112.3, 108.7, 115.2, 110.8, 98.5, 102.3]);
        }

        function loadMonthData() {
            $('#monthBtn').addClass('active').siblings().removeClass('active');
            var days = Array.from({ length: 30 }, (_, i) => i + 1);
            var data = days.map(() => Math.floor(Math.random() * 20) + 10);
            updateChartData(days, data);
        }

        function updateChartData(labels, data) {
            milkChart.data.labels = labels;
            milkChart.data.datasets[0].data = data;
            milkChart.update();
        }

        // Simulate recent activity
        function simulateRecentActivity() {
            var activities = [
                { time: '10:30 AM', activity: 'Milk Entry', details: 'Added 15.5L from Cow #101', user: 'John' },
                { time: '9:45 AM', activity: 'Sale Recorded', details: 'Sold 50L to Dairy Co.', user: 'Admin' },
                { time: '9:15 AM', activity: 'Expense Added', details: 'Fodder purchase Rs. 2500', user: 'John' },
                { time: 'Yesterday', activity: 'Cow Added', details: 'New cow #105 registered', user: 'Admin' },
                { time: 'Yesterday', activity: 'Vaccination', details: 'Cow #102 vaccinated', user: 'Vet' }
            ];

            var tbody = $('#recentActivity tbody');
            tbody.empty();

            // Add current login activity
            tbody.append('<tr><td>Just now</td><td>Logged in</td><td>System access</td><td>You</td></tr>');

            // Add simulated activities
            activities.forEach(function (activity) {
                tbody.append('<tr><td>' + activity.time + '</td><td>' + activity.activity +
                    '</td><td>' + activity.details + '</td><td>' + activity.user + '</td></tr>');
            });
        }

        // Initialize recent activity
        $(document).ready(function () {
            simulateRecentActivity();
        });
    </script>

    <style>
        .btn-circle {
            width: 70px;
            height: 70px;
            padding: 10px 16px;
            border-radius: 35px;
            font-size: 24px;
            line-height: 1.33;
        }

            .btn-circle.btn-lg {
                width: 80px;
                height: 80px;
                padding: 13px 18px;
                border-radius: 40px;
                font-size: 28px;
                line-height: 1.33;
            }

        .card {
            border-radius: 10px;
        }

        .border-left-primary {
            border-left: 0.25rem solid #4e73df !important;
        }

        .border-left-success {
            border-left: 0.25rem solid #1cc88a !important;
        }

        .border-left-warning {
            border-left: 0.25rem solid #f6c23e !important;
        }

        .border-left-danger {
            border-left: 0.25rem solid #e74a3b !important;
        }
    </style>
}