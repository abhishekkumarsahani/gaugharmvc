@model GauGhar.Models.DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
}

<!-- Custom CSS for Dashboard -->
<style>
    :root {
        --primary: #4e73df;
        --secondary: #858796;
        --success: #1cc88a;
        --info: #36b9cc;
        --warning: #f6c23e;
        --danger: #e74a3b;
        --light: #f8f9fc;
        --dark: #5a5c69;
    }

    .dashboard-container {
        min-height: 100vh;
        background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
    }

    /* Stats Cards Enhancement */
    .stat-card {
        transition: all 0.3s ease;
        border: none;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .stat-card .card-body {
            padding: 1.5rem;
        }

        .stat-card .icon-wrapper {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            color: white;
        }

        .stat-card.total-cows .icon-wrapper {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-card.today-milk .icon-wrapper {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stat-card.today-sales .icon-wrapper {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .stat-card.today-expenses .icon-wrapper {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
        }

    /* Chart Container */
    .chart-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    /* Quick Actions */
    .quick-action-btn {
        transition: all 0.3s ease;
        width: 80px;
        height: 80px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: white;
        text-decoration: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

        .quick-action-btn:hover {
            transform: scale(1.1);
            color: white;
            text-decoration: none;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

    /* Time Period Buttons */
    .period-btn-group .btn {
        border-radius: 8px;
        padding: 0.5rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }

        .period-btn-group .btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 6px rgba(78, 115, 223, 0.3);
        }

        .period-btn-group .btn:not(.active):hover {
            background: rgba(78, 115, 223, 0.1);
            border-color: var(--primary);
            color: var(--primary);
        }

    /* Progress Circles */
    .progress-circle {
        position: relative;
        display: inline-block;
        width: 120px;
        height: 120px;
    }

        .progress-circle svg {
            width: 100%;
            height: 100%;
        }

        .progress-circle .progress-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: bold;
        }

    /* Activity Table */
    .activity-table {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

        .activity-table tbody tr {
            transition: background-color 0.2s ease;
        }

            .activity-table tbody tr:hover {
                background-color: rgba(78, 115, 223, 0.05);
            }

    /* Badge Styling */
    .badge {
        padding: 0.35em 0.65em;
        font-size: 0.75em;
        border-radius: 10px;
        font-weight: 600;
    }

    /* Responsive Adjustments */
    @@media (max-width: 768px) {
        .stat-card .icon-wrapper {
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
        }

        .quick-action-btn {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            border-radius: 15px;
        }

        .period-btn-group .btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
    }

    @@media (max-width: 576px) {
        .stat-card .card-body {
            padding: 1rem;
        }

        .quick-action-btn {
            width: 50px;
            height: 50px;
            font-size: 1.25rem;
        }

        .chart-container {
            padding: 1rem;
        }
    }

    /* Animation for numbers */
    .counter {
        font-weight: 700;
        font-size: 2rem;
        color: var(--dark);
    }

    /* Card header styling */
    .card-header {
        background: white;
        border-bottom: 2px solid var(--light);
        font-weight: 700;
        color: var(--dark);
    }

    /* Gradient backgrounds for cards */
    .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

        .gradient-bg .text-muted {
            color: rgba(255, 255, 255, 0.8) !important;
        }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 10px;
    }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
</style>

<div class="dashboard-container">
    <!-- Page Header -->
    <div class="container-fluid py-4">
        <div class="row align-items-center mb-4">
            <div class="col-lg-8">
                <h1 class="h2 mb-2">
                    <i class="bi bi-speedometer2 me-2 text-primary"></i>Farm Dashboard
                </h1>
                <p class="text-muted mb-0">Welcome back! Here's what's happening with your farm today.</p>
            </div>
            <div class="col-lg-4 text-lg-end">
                <div class="period-btn-group btn-group shadow-sm" role="group">
                    <button type="button" class="btn btn-light active" id="todayBtn">
                        <i class="bi bi-calendar-day me-2"></i>Today
                    </button>
                    <button type="button" class="btn btn-light" id="weekBtn">
                        <i class="bi bi-calendar-week me-2"></i>Week
                    </button>
                    <button type="button" class="btn btn-light" id="monthBtn">
                        <i class="bi bi-calendar-month me-2"></i>Month
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row g-4 mb-4">
            <!-- Total Cows -->
            <div class="col-xl-3 col-md-6">
                <div class="stat-card total-cows card border-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-uppercase text-muted mb-2 period-label" data-today="Total Cows" data-week="Total Cows" data-month="Total Cows">Total Cows</h6>
                                <h2 class="counter" id="totalCowsCounter">@Model.TotalCows</h2>
                                <div class="mt-3">
                                    <span class="badge bg-success me-2">Active: @Model.ActiveCows</span>
                                    <span class="badge bg-info">Pregnant: @Model.PregnantCows</span>
                                </div>
                            </div>
                            <div class="icon-wrapper">
                                <i class="bi bi-cow"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Today's Milk -->
            <div class="col-xl-3 col-md-6">
                <div class="stat-card today-milk card border-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-uppercase text-muted mb-2 period-label" data-today="Today's Milk" data-week="Weekly Milk" data-month="Monthly Milk">Today's Milk</h6>
                                <h2 class="counter" id="milkCounter">@Model.TodayMilk.ToString("0.00") <small class="fs-6">L</small></h2>
                                <div class="mt-3">
                                    <small class="d-block" id="morningMilk">
                                        <i class="bi bi-sun-fill text-warning me-1"></i>
                                        Morning: @((Model.TodayMilk / 2).ToString("0.00")) L
                                    </small>
                                    <small class="d-block mt-1" id="eveningMilk">
                                        <i class="bi bi-moon-fill text-secondary me-1"></i>
                                        Evening: @((Model.TodayMilk / 2).ToString("0.00")) L
                                    </small>
                                </div>
                            </div>
                            <div class="icon-wrapper">
                                <i class="bi bi-droplet"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Today's Sales -->
            <div class="col-xl-3 col-md-6">
                <div class="stat-card today-sales card border-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-uppercase text-muted mb-2 period-label" data-today="Today's Sales" data-week="Weekly Sales" data-month="Monthly Sales">Today's Sales</h6>
                                <h2 class="counter" id="salesCounter">₹@Model.TodaySales.ToString("N0")</h2>
                                <div class="mt-3">
                                    <span class="badge bg-success">
                                        <i class="bi bi-arrow-up me-1"></i>
                                        Daily Sales
                                    </span>
                                </div>
                            </div>
                            <div class="icon-wrapper">
                                <i class="bi bi-cash-stack"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Today's Expenses -->
            <div class="col-xl-3 col-md-6">
                <div class="stat-card today-expenses card border-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-uppercase text-muted mb-2 period-label" data-today="Today's Expenses" data-week="Weekly Expenses" data-month="Monthly Expenses">Today's Expenses</h6>
                                <h2 class="counter" id="expensesCounter">₹@Model.TodayExpenses.ToString("N0")</h2>
                                <div class="mt-3">
                                    <span class="badge bg-danger">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        Monitor
                                    </span>
                                </div>
                            </div>
                            <div class="icon-wrapper">
                                <i class="bi bi-receipt"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts and Analytics -->
        <div class="row g-4 mb-4">
            <!-- Milk Production Chart -->
            <div class="col-xl-8">
                <div class="chart-container">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h5 class="mb-1">
                                <i class="bi bi-graph-up me-2 text-primary"></i>
                                <span id="chartTitle">Milk Production Trend</span>
                            </h5>
                            <p class="text-muted mb-0" id="chartSubtitle">Daily milk production in liters</p>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button"
                                    data-bs-toggle="dropdown" id="chartPeriodBtn">
                                Last 7 Days
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item chart-period" href="#" data-period="week">Last 7 Days</a></li>
                                <li><a class="dropdown-item chart-period" href="#" data-period="month">This Month</a></li>
                                <li><a class="dropdown-item chart-period" href="#" data-period="year">This Year</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="milkProductionChart" height="250"></canvas>
                    </div>
                </div>
            </div>

            <!-- Analytics Sidebar -->
            <div class="col-xl-4">
                <!-- Profit/Loss Summary -->
                <div class="chart-container mb-4">
                    <h5 class="mb-4">
                        <i class="bi bi-pie-chart me-2 text-primary"></i>
                        <span id="profitLossTitle">Profit & Loss Summary</span>
                    </h5>
                    <div class="text-center">
                        <div class="progress-circle mb-3" id="profitLossCircle">
                            <!-- SVG will be inserted here by JavaScript -->
                        </div>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="h5 text-success mb-1" id="totalSales">₹@Model.TodaySales.ToString("N0")</div>
                                <small class="text-muted">Sales</small>
                            </div>
                            <div class="col-4">
                                <div class="h5 text-danger mb-1" id="totalExpenses">₹@Model.TodayExpenses.ToString("N0")</div>
                                <small class="text-muted">Expenses</small>
                            </div>
                            <div class="col-4">
                                <div class="h5 text-primary mb-1" id="netProfit">₹@((Model.TodaySales - Model.TodayExpenses).ToString("N0"))</div>
                                <small class="text-muted">Net</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="chart-container">
                    <h5 class="mb-4">
                        <i class="bi bi-lightning me-2 text-primary"></i>
                        Quick Stats
                    </h5>
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="text-center p-3 bg-light rounded">
                                <div class="h4 mb-2 text-primary" id="avgMilkPerCow">
                                    @if (Model.TotalCows > 0)
                                    {
                                        @((Model.TodayMilk / Model.TotalCows).ToString("0.0"))
                                    }
                                    else
                                    {
                                        <text>0.0</text>
                                    }
                                </div>
                                <small class="text-muted">Avg Milk/Cow (L)</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3 bg-light rounded">
                                <div class="h4 mb-2 text-success" id="milkRate">
                                    @if (Model.TodayMilk > 0)
                                    {
                                        @((Model.TodaySales / Model.TodayMilk).ToString("0.0"))
                                    }
                                    else
                                    {
                                        <text>0.0</text>
                                    }
                                </div>
                                <small class="text-muted">Milk Rate (₹/L)</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3 bg-light rounded">
                                <div class="h4 mb-2 text-warning" id="expenseRatio">
                                    @if (Model.TodaySales > 0)
                                    {
                                        @(((Model.TodayExpenses / Model.TodaySales) * 100).ToString("0") + "%")
                                    }
                                    else
                                    {
                                        <text>0%</text>
                                    }
                                </div>
                                <small class="text-muted">Expense Ratio</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3 bg-light rounded">
                                <div class="h4 mb-2 text-info" id="profitMargin">
                                    @if (Model.TodaySales > 0)
                                    {
                                        @((((Model.TodaySales - Model.TodayExpenses) / Model.TodaySales) * 100).ToString("0") + "%")
                                    }
                                    else
                                    {
                                        <text>0%</text>
                                    }
                                </div>
                                <small class="text-muted">Profit Margin</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="chart-container">
                    <h5 class="mb-4">
                        <i class="bi bi-lightning-charge me-2 text-primary"></i>
                        Quick Actions
                    </h5>
                    <div class="row g-3 justify-content-center">
                        <div class="col-auto text-center">
                            <a asp-controller="Milk" asp-action="Create" class="quick-action-btn bg-success">
                                <i class="bi bi-plus-lg"></i>
                            </a>
                            <p class="mt-2 mb-0 small fw-semibold">Add Milk</p>
                        </div>
                        <div class="col-auto text-center">
                            <a asp-controller="Sales" asp-action="Create" class="quick-action-btn bg-warning">
                                <i class="bi bi-cart-plus"></i>
                            </a>
                            <p class="mt-2 mb-0 small fw-semibold">Record Sale</p>
                        </div>
                        <div class="col-auto text-center">
                            <a asp-controller="Expense" asp-action="Create" class="quick-action-btn bg-danger">
                                <i class="bi bi-cash-coin"></i>
                            </a>
                            <p class="mt-2 mb-0 small fw-semibold">Add Expense</p>
                        </div>
                        <div class="col-auto text-center">
                            <a asp-controller="Cow" asp-action="Create" class="quick-action-btn bg-primary">
                                <i class="bi bi-plus-circle"></i>
                            </a>
                            <p class="mt-2 mb-0 small fw-semibold">Add Cow</p>
                        </div>
                        <div class="col-auto text-center">
                            <a asp-controller="Cow" asp-action="Index" class="quick-action-btn bg-info">
                                <i class="bi bi-list-ul"></i>
                            </a>
                            <p class="mt-2 mb-0 small fw-semibold">View Cows</p>
                        </div>
                        <div class="col-auto text-center">
                            <a asp-controller="Milk" asp-action="Index" class="quick-action-btn bg-secondary">
                                <i class="bi bi-clipboard-data"></i>
                            </a>
                            <p class="mt-2 mb-0 small fw-semibold">Milk Records</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="row">
            <div class="col-12">
                <div class="chart-container">
                    <h5 class="mb-4">
                        <i class="bi bi-clock-history me-2 text-primary"></i>
                        Recent Activity
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-hover activity-table">
                            <thead class="table-light">
                                <tr>
                                    <th>Time</th>
                                    <th>Activity</th>
                                    <th>Details</th>
                                    <th>User</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivity">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global variables
        let currentPeriod = 'today';
        let milkChart = null;
        let isInitialized = false;

        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM loaded, initializing dashboard...');

            // Animate the main counters
            animateAllCounters();

            // Initialize chart
            initializeMilkChart();

            // Set up period buttons
            setupPeriodButtons();

            // Set up chart period buttons
            setupChartPeriodButtons();

            // Load initial data
            loadProfitLossData('today');
            simulateRecentActivity();

            isInitialized = true;
            console.log('Dashboard initialized successfully');
        });

        function animateAllCounters() {
            $('.counter').each(function () {
                const text = $(this).text();
                // Extract numeric value from text
                const match = text.replace(/[^0-9.]/g, '');
                if (match) {
                    const value = parseFloat(match);
                    animateCounter(this, 0, value, 1000);
                }
            });
        }

        function animateCounter(element, start, end, duration) {
            const startTime = Date.now();
            const updateCounter = () => {
                const currentTime = Date.now();
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);

                let currentValue;
                if (progress < 1) {
                    currentValue = Math.floor(start + (end - start) * progress);
                    requestAnimationFrame(updateCounter);
                } else {
                    currentValue = end;
                }

                // Format the display
                if (element.id === 'milkCounter') {
                    element.innerHTML = currentValue.toFixed(2) + ' <small class="fs-6">L</small>';
                } else if (element.id === 'salesCounter' || element.id === 'expensesCounter') {
                    element.textContent = '₹' + currentValue.toLocaleString();
                } else {
                    element.textContent = currentValue;
                }
            };

            requestAnimationFrame(updateCounter);
        }

        function initializeMilkChart() {
            console.log('Initializing milk chart...');
            try {
                const ctx = document.getElementById('milkProductionChart').getContext('2d');
                milkChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{
                            label: 'Milk Production (L)',
                            data: [65, 68, 72, 75, 73, 70, 68],
                            borderColor: '#4e73df',
                            backgroundColor: 'rgba(78, 115, 223, 0.05)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#4e73df',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#4e73df',
                                borderWidth: 1,
                                cornerRadius: 8
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: {
                                    drawBorder: false
                                },
                                ticks: {
                                    callback: function (value) {
                                        return value + ' L';
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                console.log('Milk chart initialized successfully');
            } catch (error) {
                console.error('Error initializing chart:', error);
            }
        }

        function setupPeriodButtons() {
            console.log('Setting up period buttons...');

            // Remove any existing event listeners
            $('#todayBtn').off('click');
            $('#weekBtn').off('click');
            $('#monthBtn').off('click');

            // Add new event listeners
            $('#todayBtn').on('click', function () {
                console.log('Today button clicked');
                setActivePeriodButton('today');
                updateDashboardForPeriod('today');
            });

            $('#weekBtn').on('click', function () {
                console.log('Week button clicked');
                setActivePeriodButton('week');
                updateDashboardForPeriod('week');
            });

            $('#monthBtn').on('click', function () {
                console.log('Month button clicked');
                setActivePeriodButton('month');
                updateDashboardForPeriod('month');
            });

            console.log('Period buttons set up successfully');
        }

        function setActivePeriodButton(period) {
            $('.period-btn-group .btn').removeClass('active');
            $(`#${period}Btn`).addClass('active');
        }

        function updateDashboardForPeriod(period) {
            console.log('Updating dashboard for period:', period);

            // Update labels
            $('.period-label').each(function () {
                const newText = $(this).data(period);
                $(this).text(newText);
            });

            // Update counter values based on period
            const milkData = getPeriodData(period);

            // Animate counters to new values
            animateCounter(document.getElementById('totalCowsCounter'), 0, milkData.totalCows, 800);
            animateCounter(document.getElementById('milkCounter'), 0, milkData.milk, 800);
            animateCounter(document.getElementById('salesCounter'), 0, milkData.sales, 800);
            animateCounter(document.getElementById('expensesCounter'), 0, milkData.expenses, 800);

            // Update milk breakdown
            $('#morningMilk').html(
                `<i class="bi bi-sun-fill text-warning me-1"></i>Morning: ${milkData.morningMilk} L`
            );
            $('#eveningMilk').html(
                `<i class="bi bi-moon-fill text-secondary me-1"></i>Evening: ${milkData.eveningMilk} L`
            );

            // Update profit/loss data
            updateProfitLossData(period);

            // Update quick stats
            updateQuickStats(period);

            console.log('Dashboard updated for period:', period);
        }

        function getPeriodData(period) {
            const baseMilk = @Model.TodayMilk;
            const baseSales = @Model.TodaySales;
            const baseExpenses = @Model.TodayExpenses;
            const totalCows = @Model.TotalCows;

            let data = {
                totalCows: totalCows,
                milk: baseMilk,
                sales: baseSales,
                expenses: baseExpenses,
                morningMilk: (baseMilk / 2).toFixed(2),
                eveningMilk: (baseMilk / 2).toFixed(2)
            };

            switch (period) {
                case 'week':
                    data.milk = baseMilk * 7;
                    data.sales = baseSales * 7;
                    data.expenses = baseExpenses * 7;
                    data.morningMilk = ((baseMilk * 7) / 14).toFixed(2);
                    data.eveningMilk = ((baseMilk * 7) / 14).toFixed(2);
                    break;
                case 'month':
                    data.milk = baseMilk * 30;
                    data.sales = baseSales * 30;
                    data.expenses = baseExpenses * 30;
                    data.morningMilk = ((baseMilk * 30) / 60).toFixed(2);
                    data.eveningMilk = ((baseMilk * 30) / 60).toFixed(2);
                    break;
            }

            return data;
        }

        function setupChartPeriodButtons() {
            console.log('Setting up chart period buttons...');

            $('.chart-period').off('click').on('click', function (e) {
                e.preventDefault();
                const period = $(this).data('period');
                console.log('Chart period selected:', period);
                updateChartData(period);
                $('#chartPeriodBtn').text($(this).text());
            });
        }

        function updateChartData(period) {
            if (!milkChart) {
                console.error('Chart not initialized');
                return;
            }

            console.log('Updating chart data for period:', period);

            let labels, data, title, subtitle;

            switch (period) {
                case 'month':
                    labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
                    data = [450, 480, 520, 510];
                    title = 'Monthly Milk Production';
                    subtitle = 'Weekly milk production in liters';
                    break;
                case 'year':
                    labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    data = [3200, 3350, 3450, 3550, 3650, 3750, 3850, 3950, 4050, 4150, 4250, 4350];
                    title = 'Yearly Milk Production';
                    subtitle = 'Monthly milk production in liters';
                    break;
                default: // week
                    labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                    data = [105.5, 112.3, 108.7, 115.2, 110.8, 98.5, 102.3];
                    title = 'Weekly Milk Production';
                    subtitle = 'Daily milk production in liters';
                    break;
            }

            milkChart.data.labels = labels;
            milkChart.data.datasets[0].data = data;
            milkChart.update();

            $('#chartTitle').text(title);
            $('#chartSubtitle').text(subtitle);

            console.log('Chart updated successfully');
        }

        function createProfitLossCircle(profitPercentage, isProfit) {
            const radius = 50;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (Math.abs(profitPercentage) / 100) * circumference;
            const color = isProfit ? '#1cc88a' : '#e74a3b';

            return `
                        <svg width="120" height="120" viewBox="0 0 120 120">
                            <circle cx="60" cy="60" r="${radius}" stroke="#e0e0e0" stroke-width="10" fill="none"/>
                            <circle cx="60" cy="60" r="${radius}" stroke="${color}"
                                    stroke-width="10" fill="none" stroke-dasharray="${circumference}"
                                    stroke-dashoffset="${offset}" transform="rotate(-90 60 60)"
                                    stroke-linecap="round"/>
                            <text x="60" y="55" text-anchor="middle" font-size="18" font-weight="bold" fill="${color}">
                                ${Math.abs(profitPercentage).toFixed(1)}%
                            </text>
                            <text x="60" y="75" text-anchor="middle" font-size="12" fill="#666">
                                ${isProfit ? 'Profit' : 'Loss'}
                            </text>
                        </svg>
                    `;
        }

        function loadProfitLossData(period) {
            console.log('Loading profit/loss data for period:', period);
            updateProfitLossData(period);
        }

        function updateProfitLossData(period) {
            console.log('Updating profit/loss for period:', period);

            const baseSales = @Model.TodaySales;
            const baseExpenses = @Model.TodayExpenses;

            let sales, expenses;

            switch (period) {
                case 'week':
                    sales = baseSales * 7;
                    expenses = baseExpenses * 7;
                    $('#profitLossTitle').text('Weekly Profit & Loss');
                    break;
                case 'month':
                    sales = baseSales * 30;
                    expenses = baseExpenses * 30;
                    $('#profitLossTitle').text('Monthly Profit & Loss');
                    break;
                default:
                    sales = baseSales;
                    expenses = baseExpenses;
                    $('#profitLossTitle').text('Daily Profit & Loss');
                    break;
            }

            const profit = sales - expenses;
            const profitPercentage = sales > 0 ? (profit / sales) * 100 : 0;
            const isProfit = profit >= 0;

            $('#totalSales').text('₹' + sales.toLocaleString());
            $('#totalExpenses').text('₹' + expenses.toLocaleString());
            $('#netProfit').text('₹' + profit.toLocaleString());

            // Remove all color classes first
            $('#netProfit').removeClass('text-success text-danger text-primary');

            // Add appropriate color class
            if (isProfit) {
                $('#netProfit').addClass('text-success');
            } else {
                $('#netProfit').addClass('text-danger');
            }

            $('#profitLossCircle').html(createProfitLossCircle(profitPercentage, isProfit));
            console.log('Profit/loss updated successfully');
        }

        function updateQuickStats(period) {
            console.log('Updating quick stats for period:', period);

            const baseMilk = @Model.TodayMilk;
            const baseSales = @Model.TodaySales;
            const baseExpenses = @Model.TodayExpenses;
            const totalCows = @Model.TotalCows;

            let milk, sales, expenses;

            switch (period) {
                case 'week':
                    milk = baseMilk * 7;
                    sales = baseSales * 7;
                    expenses = baseExpenses * 7;
                    break;
                case 'month':
                    milk = baseMilk * 30;
                    sales = baseSales * 30;
                    expenses = baseExpenses * 30;
                    break;
                default:
                    milk = baseMilk;
                    sales = baseSales;
                    expenses = baseExpenses;
                    break;
            }

            const avgMilkPerCow = totalCows > 0 ? (milk / totalCows).toFixed(1) : '0.0';
            const milkRate = milk > 0 ? (sales / milk).toFixed(1) : '0.0';
            const expenseRatio = sales > 0 ? ((expenses / sales) * 100).toFixed(0) : '0';
            const profitMargin = sales > 0 ? (((sales - expenses) / sales) * 100).toFixed(0) : '0';

            $('#avgMilkPerCow').text(avgMilkPerCow);
            $('#milkRate').text(milkRate);
            $('#expenseRatio').text(expenseRatio + '%');
            $('#profitMargin').text(profitMargin + '%');

            console.log('Quick stats updated successfully');
        }

        function simulateRecentActivity() {
            console.log('Loading recent activity...');

            const activities = [
                { time: '10:30 AM', activity: 'Milk Entry', details: 'Added 15.5L from Cow #101', user: 'John' },
                { time: '9:45 AM', activity: 'Sale Recorded', details: 'Sold 50L to Dairy Co.', user: 'Admin' },
                { time: '9:15 AM', activity: 'Expense Added', details: 'Fodder purchase ₹2500', user: 'John' },
                { time: 'Yesterday', activity: 'Cow Added', details: 'New cow #105 registered', user: 'Admin' },
                { time: 'Yesterday', activity: 'Vaccination', details: 'Cow #102 vaccinated', user: 'Vet' },
                { time: '2 days ago', activity: 'Milk Entry', details: 'Added 16.2L from Cow #103', user: 'John' },
                { time: '3 days ago', activity: 'Health Check', details: 'Routine check for Cow #104', user: 'Vet' }
            ];

            const tbody = $('#recentActivity');
            tbody.empty();

            // Add current login
            tbody.append(`
                        <tr>
                            <td><span class="badge bg-success">Just now</span></td>
                            <td><i class="bi bi-door-open me-2"></i>Logged in</td>
                            <td>System access</td>
                            <td><span class="badge bg-primary">You</span></td>
                        </tr>
                    `);

            // Add other activities
            activities.forEach(activity => {
                tbody.append(`
                            <tr>
                                <td>${activity.time}</td>
                                <td>${activity.activity}</td>
                                <td>${activity.details}</td>
                                <td>${activity.user}</td>
                            </tr>
                        `);
            });

            console.log('Recent activity loaded successfully');
        }

        // Make functions available globally for debugging
        window.dashboard = {
            updateDashboardForPeriod,
            updateChartData,
            updateProfitLossData,
            updateQuickStats,
            getPeriodData
        };
    </script>
}